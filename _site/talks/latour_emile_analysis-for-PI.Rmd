```{r setup, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(comment = NA, 
                      warning = FALSE, 
                      error = FALSE, 
                      message = FALSE, 
                      tidy = FALSE, 
                      eval = TRUE, 
                      include = TRUE, 
                      echo = TRUE,  # change to FALSE when delivering
                      dpi = 300, 
                      fig.width = 8, 
                      fig.height = 4, 
                      out.width = "100%")


# Colors for plots 

sb_deep <- c("#4C72B0", "#C44E52","#55A868", 
             "#8172B2", "#CCB974", "#64B5CD")

```

```{r load-packages, include = FALSE, warnings = FALSE, errors = FALSE, messages = FALSE}

# Check if package is installed. If not, install it.

pkg <- c("tidyverse", 
         "janitor", 
         "knitr", 
         "ggthemes", 
         "broom", 
         "lme4", 
         "lmerTest")

new.pkg <- pkg[!(pkg %in% installed.packages())]

if (length(new.pkg))
  install.packages(new.pkg, repos = "http://cran.rstudio.com")

lapply(pkg, library, character.only = TRUE)


```



# Introduction

7 cohorts of approximately 5 mice each were given osteosarcoma. Once tumor size grew to approximately 0.2 cm^3^, the mice would begin treatment with one of seven drug treatments. Note that there was no randomization scheme used to assign the mice to different treatments. 

Since beginning treatment is dependent on tumor size, mice began treatment at different times. They were all treated and monitored for the same amount of time: 60 days from start of treatment.

In this analysis, we aim to determine if there is a statistically significant difference in the rate of tumor growth between 4 of the groups:

- As,
- B, 
- C, and 
- D.

# Counts and spaghetti plots

```{r read-in-data, include = FALSE}

valdata <- readr::read_rds("./mice_data.rds")

# valdata <- valdata %>% 
#   dplyr::filter(!(id %in% c("010", "404", "366", "676")))

```

## Counts table

Here are the counts of the mice by treatment group.

```{r table-of-counts-2}

counts <- valdata %>% 
  distinct(id, .keep_all = TRUE) %>% 
  janitor::tabyl(treatment) %>% 
  janitor::add_totals_row() %>% 
  # janitor::adorn_totals("row") %>% 
  mutate(percent = round(percent, 2))

knitr::kable(counts, 
      col.names = c("Treatment", "Count", "Percent"))

```

## Plot by individual with untransformed tumor volume

Plot to see change in tumor volume over time by each individual mouse.

```{r spaghetti-plot-2}

plt <- ggplot(data = valdata, 
              aes(x = days, y = vol_cc_sphere, color = trt)) + 
  # geom_point(size = 0.8) + 
  geom_line(aes(group = id)) + 
  labs(title = "Plot of tumor volume, by mouse", x = "Days of treatment", 
       y = "Tumor volume, cc") + 
  scale_color_manual(name = "Treatment", 
                     values = sb_deep) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.key = element_blank())

suppressWarnings(print(plt))
```


## Plot by individual with log~2~ transformed tumor volume

Plot to see change in log~2~ tumor volume over time by each individual mouse.

```{r spaghetti-plot-3}

log_plt <- ggplot(data = valdata, 
                  aes(x = days, y = vol_log2, color = trt)) + 
  # geom_point(size = 0.8) + 
  geom_line(aes(group = id)) + 
  labs(title = expression("Plot of log"[2]*" tumor volume, by mouse"), 
       x = "Days of treatment", 
       # y = "Log2 Tumor volume (Log2 cc)") + 
       y = expression("log"[2]*" Tumor volume, log"[2]*"(cc)")) + 
  scale_color_manual(name = "Treatment", 
                     values = sb_deep) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.key = element_blank())

suppressWarnings(print(log_plt))
```


# Linear mixed effects model

The table below shows the results of the fixed effects from the linear mixed effects model specified in the Appendix. Note that the time variable `Days` is statistically significant at the $\alpha$ = 0.05 level. As are the interaction terms for B and for D.

```{r longitudinal-analysis-with-lme4}

# Random slope model fit with lmerTest

log_tumor_mod <- 
  lmerTest::lmer(vol_log2 ~ trt * days + (days | id), data = valdata)

# Get just the coefficient matrix from the output

tidy_mod <- (summary(log_tumor_mod))$coefficients

tm_rownames <- c("Intercept", "TRT = B", "TRT = C", 
                 "TRT = D", "Days", "(TRT = B) * Days", 
                 "(TRT = C) * Days", "(TRT = D) * Days")

# Coerce to a data frame

tidy_mod <- as.data.frame(tidy_mod, row.names = tm_rownames)

# Format the p-values

# dim(tidy_mod)
# tidy_mod[, 5]

tidy_mod[, 5] <- format.pval(tidy_mod[ , 5], eps = .001, digits = 2)

# format the rest of the numbers

tidy_mod[, -5] <- round(tidy_mod[, -5], digits = 3)

# Add some indication of signicant p-value

tidy_mod$Sig <- ifelse(tidy_mod[, 5] < 0.05, "***", "")

knitr::kable(tidy_mod)

```

# Compare and test the treatment groups

Using the model results, test whether the rate of change in log~2~ tumor volume is the same between the groups. Then test the groups in pairs.

```{r calc-slopes-and-intercepts-for-plot, include=FALSE}

# get the beta coefficients from the model
b <- matrix(log_tumor_mod@beta, ncol = 1)

# calculate the intercepts
intercepts <- c(b[1, 1],  # A
                b[1, 1] + b[2, 1],  # B
                b[1, 1] + b[3, 1],  # C
                b[1, 1] + b[4, 1])  # D
slopes <- c(b[5, 1], # A
            b[5, 1] + b[6, 1],  # B
            b[5, 1] + b[7, 1],  # C
            b[5, 1] + b[8, 1])  # D

# Set up to merge the slopes and intercepts with the main file
treat_names <- dput(unique(valdata$treatment))
trt_lines <- data.frame(treatment = treat_names,
                        intercepts = intercepts,
                        slopes = slopes)

# Add data to draw the fitted lines and back-transformed fitted lines.
valdata <- valdata %>% 
  dplyr::left_join(., trt_lines, by = "treatment") %>% 
  mutate(draw = intercepts + slopes * days, 
         draw_exp = 2 ^ draw)

glimpse(valdata)

```

## Plot of log~2~ tumor volume, by group with fitted lines

```{r plot-by-group}

gg <- ggplot(data = valdata, 
             aes(x = days, y = vol_log2, color = treatment)) + 
  geom_line(aes(group = id)) + 
  labs(title = expression("Plot of log"[2]*" tumor volume, by mouse"), 
       x = "Days of treatment", 
       # y = "Log2 Tumor volume (Log2 cc)") + 
       y = expression("log"[2]*" Tumor volume, log"[2]*"(cc)")) + 
  scale_color_manual(name = "Treatment", 
                     values = sb_deep) + 
  geom_line(data = valdata, 
            aes(x = days, y = draw), 
            color = "black", 
            size = 0.9) + 
  facet_wrap(~ treatment, nrow = 1) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.key = element_blank(), 
        legend.position = "none") + 
  theme(strip.background = element_blank(), 
           strip.text = element_text(face = "bold"))


suppressWarnings(print(gg))

```


## Plot of (back-transformed) tumor volume, by group with fitted lines

Here is a plot of the original data by group with fitted regression lines on the same scale.

```{r plot-by-group-exp}

gg_exp <- ggplot(data = valdata, 
                 aes(x = days, y = vol_cc_sphere, color = treatment)) + 
  geom_line(aes(group = id)) + 
  labs(title = expression("Plot of tumor volume, by mouse"), 
       x = "Days of treatment", 
       y = expression("Tumor volume, cc")) + 
  scale_color_manual(name = "Treatment", 
                     values = sb_deep) + 
  geom_line(data = valdata, 
            aes(x = days, y = draw_exp), 
            color = "black", 
            size = 0.9) + 
  facet_wrap(~ treatment, nrow = 1) + 
  theme_bw() + 
  theme(panel.border = element_blank(), 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.key = element_blank(), 
        legend.position = "none") + 
  theme(strip.background = element_blank(), 
           strip.text = element_text(face = "bold"))


suppressWarnings(print(gg_exp))

```


## Test that slopes are the same for all treatment groups

See Appendix for statement of hypothesis test.

```{r, include=FALSE}
# Test the hypothesis that slopes are equal for all trt groups
# Alternative: at least one of them is different
test_all <- car::Anova(log_tumor_mod, type = "II", test.statistic = "Chisq")
chisq_test_all <- test_all[3, 1]
df_test_all <- test_all[3, 2]
pval_test_all <- test_all[3, 3]
test_all
```

### Conclusion:

Based on the data for the study mice, we reject the null hypothesis that the rates of change in log~2~ tumor volume are equal for the 4 treatment groups ($\chi^2_{df=`r df_test_all`}$ = `r round(chisq_test_all, 2)`; *p*-value `r ifelse(pval_test_all < 0.001, "< 0.001", round(pval_test_all, 3))`). We conclude that there is a statistically significant difference in the rate of change in log~2~ tumor volume for at least one of the treatment groups compared to the rest.


## Compare the slopes between each of the groups
Since we determined above that the rate of change in log~2~ tumor volume is different for at least one of the treatment groups, we will test each group against one another to determine which groups are different.

See the Appendix for the stated linear contrasts.

```{r create-lincom-function, include = FALSE}
# First I need to create a function to perform the linear combinations:

# K <- matrix(data = c(0, 0, 0, 1, 1, 0), nrow = 1)

lincom <- function(k, fit) {
  
  # get the beta coefficients
  bhat <- matrix(fit@beta, ncol = 1)
  
  # Get the variance covariance matrix
  v <- as.matrix(vcov(fit))
  
  # Calculate the standard error
  se <- sqrt(k %*% v %*% t(k))
  
  # estimate the value of the linear combination
  est <- k %*% bhat
  
  # Determine the z-score
  z_score <- (est - 0) / se
  
  # Calculate the p-value
  p_value <- 2 * (1 - pnorm(q = z_score, 
                            mean = 0, sd = 1, 
                            lower.tail = TRUE, log.p = FALSE))
  p_value <- as.double(p_value)
  
  # determine the z-statistic for the 95% CI
  z_stat <- qnorm(p = 1 - 0.05 / 2, 
                  mean = 0, sd = 1, 
                  lower.tail = TRUE, log.p = FALSE)
  
  # Upper and Lower 95% CIs
  lower_ci <- est - z_stat * se
  upper_ci <- est + z_stat * se
  
  result <- data.frame("Coef" = est, "Std_Err" = se, "z" = round(z_score, 3), 
                       # "p-value" = sprintf("%.3f", p_value), 
                       # "p-value" = format.pval(p_value, eps = .001, digits = 2), 
                       "p_value" = p_value, 
                       "LL_95CI" = lower_ci, "UL_95CI" = upper_ci)
  
  result
}
```

### Summary of slopes

```{r lincom-summary}

D_vs_B = matrix(data = c(0, 0, 0, 0, 0, 1, 0, -1), nrow = 1)
D_vs_C = matrix(data = c(0, 0, 0, 0, 0, 0, 1, -1), nrow = 1)
D_vs_A = matrix(data = c(0, 0, 0, 0, 0, 0, 0, -1), nrow = 1)
B_vs_C = matrix(data = c(0, 0, 0, 0, 0, -1, 1, 0), nrow = 1)
B_vs_A = matrix(data = c(0, 0, 0, 0, 0, -1, 0, 0), nrow = 1)
C_vs_A = matrix(data = c(0, 0, 0, 0, 0, 0, -1, 0), nrow = 1)


l1 <- lincom(B_vs_A, log_tumor_mod)
l2 <- lincom(C_vs_A, log_tumor_mod)
l3 <- lincom(D_vs_A, log_tumor_mod)
l4 <- lincom(B_vs_C, log_tumor_mod)
l5 <- lincom(D_vs_B, log_tumor_mod)
l6 <- lincom(D_vs_C, log_tumor_mod)

l_cs <- rbind(l1, l2, l3, l4, l5, l6)
rm(l1, l2, l3, l4, l5, l6)

rownames(l_cs) <- c("B vs. A", 
                    "C vs. A", 
                    "D vs. A", 
                    "B vs. C", 
                    "D vs. B", 
                    "D vs. C")

# format some of the output
l_cs[, -4] <- round(l_cs[, -4], digits = 4)

# Add some indication of signicant p-value
l_cs$Sig <- ifelse(as.numeric(as.character(l_cs[, 4])) > 0.05 / 6, 
                             "", "***")

l_cs[, 4] = format.pval(l_cs[, 4], eps = .001, digits = 2)

knitr::kable(l_cs)
```

### Conclusion

The pre-specified significance level, $\alpha$ = 0.05, has been adjusted for the 6 slope comparisons. At the adjusted level, there were statistically significant differences in the rate of change in log~2~ tumor volume between the B group and the A group (*p*-value = `r l_cs[1, 4]`), the D group and the A group (*p*-value = `r l_cs[3, 4]`), and the D group and the B group (*p*-value = `r l_cs[6, 4]`).


# Appendix

## Linear mixed effects model 

### Model specification
As are treated as the baseline group.

<!--- IF  KNITTING TO HTML OR PDF THEN YOU NEED TO USE THE FOLLOWING SYNTAX -->

\begin{align*}
\mathrm{log_2(VOL)} &= \beta_0 \\
    &+ \beta_{1}  \mathrm{TRT}_{B} \\
    &+ \beta_{2}  \mathrm{TRT}_{C}    \\
    &+ \beta_{3}  \mathrm{TRT}_{D} \\
    &+ \beta_{4}  \mathrm{DAYS} \\
    &+ \beta_{5}  \mathrm{TRT}_{B}\times  \mathrm{DAYS}  \\
    &+ \beta_{6}  \mathrm{TRT}_{C}\times  \mathrm{DAYS}  \\
    &+ \beta_{7}  \mathrm{TRT}_{D}\times  \mathrm{DAYS}  \\
    &+ \mu_{0j} \\ 
    &+ \mu_{1}\times \mathrm{DAYS}_{ij} \\
    &+ \epsilon_{ij}
\end{align*}

<!--- IF  KNITTING TO WORD THEN YOU NEED TO USE THE FOLLOWING SYNTAX -->

<!---

$$
\begin{align*}
\mathrm{log_2(VOL)} & = \beta_0 \\
    &+ \beta_{1}  \mathrm{TRT}_{B} \\
    &+ \beta_{2}  \mathrm{TRT}_{C}    \\
    &+ \beta_{3}  \mathrm{TRT}_{D} \\
    &+ \beta_{4}  \mathrm{DAYS} \\
    &+ \beta_{5}  \mathrm{TRT}_{B}\times  \mathrm{DAYS}  \\
    &+ \beta_{6}  \mathrm{TRT}_{C}\times  \mathrm{DAYS}  \\
    &+ \beta_{7}  \mathrm{TRT}_{D}\times  \mathrm{DAYS} \\
    &+ \mu_{0j} \\
    &+ \mu_{1}\times \mathrm{DAYS}_{ij} \\
    &+ \epsilon_{ij}
\end{align*}
$$

-->


### Model output
```{r, results=TRUE, include=TRUE}
summary(log_tumor_mod)
anova(log_tumor_mod)
```

## Equations for each treatment group

### Treatment = A

$$
\mathrm{log_2(VOL)} = \beta_0 + \beta_{4} \mathrm{DAYS} 
$$


### Treatment = B

$$
\mathrm{log_2(VOL)} = (\beta_0 + \beta_{1})  + (\beta_{4}+ \beta_{5}) \mathrm{DAYS}
$$

### Treatment = C

$$
\mathrm{log_2(VOL)} = (\beta_0 + \beta_{2})  + (\beta_{4}+ \beta_{6})  \mathrm{DAYS}
$$

### Treatment = D

$$
\mathrm{log_2(VOL)} = (\beta_0 + \beta_{3})  + (\beta_{4}+ \beta_{7})  \mathrm{DAYS}
$$

### Slopes and intercepts for each treatment group

```{r slopes-and-intercepts}
knitr::kable(trt_lines)
```


## Hypothesis test of equal slope for each treatment group

### Hypothesis

$$
H_0: \beta_4 = (\beta_4 + \beta_5) = (\beta_4 + \beta_6) = (\beta_4 + \beta_7)
$$
$$
vs.
$$
$$
H_{A}: At\ least\ one\ slope\ is\ different\ than\ the\ rest.
$$

Or, alternatively:

$$
H_0: \beta_5 = \beta_6 = \beta_7 = 0
$$

$$
vs.
$$

$$
H_{A}: At\ least\ one\ slope\ is\ different\ than\ the\ rest.
$$

### Output of test
```{r hyp-test-results, results=TRUE, include=TRUE}
test_all
```



## Linear contrasts of the treatment groups

### D vs. B
$$
\beta_4 + \beta_5= \beta_4 + \beta_7 \Leftrightarrow \beta_5 - \beta_7 = 0
$$

### D vs. B
$$
\beta_4 + \beta_6 = \beta_4 + \beta_7 \Leftrightarrow \beta_6 - \beta_7 = 0
$$

### D vs. A
$$
\beta_4 = \beta_4 + \beta_7 \Leftrightarrow -\beta_7 = 0
$$

### B vs. B
$$
\beta_4 + \beta_5= \beta_4 + \beta_6 \Leftrightarrow \beta_5 - \beta_6 = 0
$$

### B vs. A
$$
\beta_4 + \beta_5 = \beta_4 \Leftrightarrow \beta_5 = 0
$$

### B vs. A
$$
\beta_4 + \beta_6 = \beta_4 \Leftrightarrow \beta_6 = 0
$$

## Session info
```{r session-info}
sessionInfo()
```


```{r save-files, include=FALSE}

getwd()

# ggsave("mice-parallel-plot.png", plt)
# ggsave("log-mice-parallel-plot.png", log_plt)
# ggsave("log-mice-fitted-lines-plot.png", gg)
# ggsave("mice-fitted-lines-plot.png", gg_exp)


rm(mouse_01, keep_trt, treat_lbls, treat_lvls)

```

