<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>rOpenSci | magick vignette</title>

     
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>
    <link rel="stylesheet" type="text/css" href="/css/style-new.css" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#4b8add">
<meta name="theme-color" content="#4b8add">


    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

    
    <div id="header">
        <div class="container">
            <div class="row center-m">
                
                <div class="col-1">
                    <a href="/index.html"><img src="/img/icon_lettering_white.svg" /></a>
                </div>
                
                
                <nav class="col-6 col-offset-4 top-3">
                    <ul class="row between">
						<li><a href="/about/">About</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/packages/">Packages</a></li>
                        <li><a href="/community/">Community</a></li>
                        <li><a href="http://discuss.ropensci.org/" target="_blank">Discuss</a></li>

                    </ul>
                </nav>
                
            </div>
        </div>
    </div>



    <article>
        <div class="container top-20">
            
            <div class="row centered">
                
                <div class="col-7 bottom-20 maintext">
                    <h1>magick vignette</h1>
                    <br>
                    <h4><small style="color:grey">for v1.4</small></h4>
                    <br>

                    <article>
                    

<p>The new <a href="https://cran.r-project.org/package=magick">magick</a> package is an ambitious effort to modernize and simplify high-quality image processing in R. It wraps the <a href="https://www.imagemagick.org/Magick++/STL.html">ImageMagick STL</a> which is perhaps the most comprehensive open-source image processing library available today.</p>

<p>The ImageMagick library has an overwhelming amount of functionality. The current version of Magick exposes a decent chunk of it, but being a first release, documentation is still sparse. This post briefly introduces the most important concepts to get started.</p>

<h3 id="installation">Installation</h3>

<p>On Windows or OS-X the package is most easily installed via CRAN.</p>

<pre><code class="language-r">install.packages(&quot;magick&quot;)
</code></pre>

<p>The binary CRAN packages work out of the box and have most important features enabled.
Use <code>magick_config</code> to see which features and formats are supported by your version of ImageMagick.</p>

<pre><code class="language-r">str(magick::magick_config())
</code></pre>

<pre><code>#&gt; List of 21
#&gt;  $ version           :Class 'numeric_version'  hidden list of 1
#&gt;   ..$ : int [1:4] 6 9 9 18
#&gt;  $ modules           : logi FALSE
#&gt;  $ cairo             : logi TRUE
#&gt;  $ fontconfig        : logi TRUE
#&gt;  $ freetype          : logi TRUE
#&gt;  $ fftw              : logi TRUE
#&gt;  $ ghostscript       : logi FALSE
#&gt;  $ jpeg              : logi TRUE
#&gt;  $ lcms              : logi FALSE
#&gt;  $ libopenjp2        : logi FALSE
#&gt;  $ lzma              : logi TRUE
#&gt;  $ pangocairo        : logi TRUE
#&gt;  $ pango             : logi TRUE
#&gt;  $ png               : logi TRUE
#&gt;  $ rsvg              : logi TRUE
#&gt;  $ tiff              : logi TRUE
#&gt;  $ webp              : logi TRUE
#&gt;  $ wmf               : logi FALSE
#&gt;  $ x11               : logi FALSE
#&gt;  $ xml               : logi TRUE
#&gt;  $ zero-configuration: logi TRUE
</code></pre>

<h3 id="image-io">Image IO</h3>

<p>What makes magick so magical is that it automatically converts and renders all common image formats. ImageMagick supports dozens of formats and automatically detects the type. Use <code>magick::magick_config()</code> to list the formats that your version of ImageMagick supports.</p>

<p><strong>Read and write</strong></p>

<p>Images can be read directly from a file path, URL, or raw vector with image data with <code>image_read</code>. The <code>image_info</code> function shows some meta data about the image, similar to the imagemagick <code>identify</code> command line utility.</p>

<pre><code class="language-r">library(magick)
tiger &lt;- image_read('http://jeroen.github.io/images/tiger.svg')
image_info(tiger)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    SVG   900    900       sRGB    68630
</code></pre>

<p>We use <code>image_write</code> to export an image in any format to a file on disk, or in memory if <code>path = NULL</code>.</p>

<pre><code class="language-r"># Render svg to png bitmap
image_write(tiger, path = &quot;tiger.png&quot;, format = &quot;png&quot;)
</code></pre>

<p>If <code>path</code> is a filename, <code>image_write</code> returns <code>path</code> on success such that the result can be piped into function taking a file path.</p>

<p><strong>Converting formats</strong></p>

<p>Magick keeps the image in memory in it&rsquo;s original format. Specify the <code>format</code> parameter <code>image_write</code> to convert to another format. You can also internally convert the image to another format earlier, before applying transformations. This can be useful if your original format is lossy.</p>

<pre><code class="language-r">tiger_png &lt;- image_convert(tiger, &quot;png&quot;)
image_info(tiger_png)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    PNG   900    900       sRGB        0
</code></pre>

<p>Note that size is currently 0 because ImageMagick is lazy (in the good sense) and does not render until it has to.</p>

<p><strong>Preview</strong></p>

<p>IDE&rsquo;s with a built-in web browser (such as RStudio) automatically display magick images in the viewer. This results in a neat interactive image editing environment.</p>

<p><img id="rstudioimg" alt="rstudio">
<script>
//this is a hack to prevent pandoc &lsquo;self_contained&rsquo; from embedding this image
//in future version of pandoc we can use the image and set &lsquo;data-external=1&rsquo; instead
window.onload = function(){
  document.getElementById(&ldquo;rstudioimg&rdquo;).src = &ldquo;<a href="https://jeroen.github.io/images/magick-rstudio.png&quot;">https://jeroen.github.io/images/magick-rstudio.png&quot;</a>;
}
</script></p>

<p>Alternatively, on Linux you can use <code>image_display</code> to preview the image in an X11 window. Finally <code>image_browse</code> opens the image in your system&rsquo;s default application for a given type.</p>

<pre><code class="language-r"># X11 only
image_display(tiger)

# System dependent
image_browse(tiger)
</code></pre>

<p>Another method is converting the image to a raster object and plot it on R&rsquo;s graphics display. However this is very slow and only useful in combination with other plotting functionality. See <a href="#raster-graphics">#raster</a> below.</p>

<h3 id="transformations">Transformations</h3>

<p>The best way to get a sense of available transformations is walk through the examples in the <code>?transformations</code> help page in RStudio. Below a few examples to get a sense of what is possible.</p>

<p><strong>Cut and edit</strong></p>

<p>Several of the transformation functions take an <code>geometry</code> parameter which requires a special syntax of the form <code>AxB+C+D</code> where each element is optional. Some examples:</p>

<ul>
<li><code>image_crop(image, &quot;100x150+50&quot;)</code>: <em>crop out <code>width:100px</code> and <code>height:150px</code> starting <code>+50px</code> from the left</em></li>
<li><code>image_scale(image, &quot;200&quot;)</code>: <em>resize proportionally to width: <code>200px</code></em></li>
<li><code>image_scale(image, &quot;x200&quot;)</code>: <em>resize proportionally to height: <code>200px</code></em></li>
<li><code>image_fill(image, &quot;blue&quot;, &quot;+100+200&quot;)</code>: <em>flood fill with blue starting at the point at <code>x:100, y:200</code></em></li>
<li><code>image_border(frink, &quot;red&quot;, &quot;20x10&quot;)</code>: <em>adds a border of 20px left+right and 10px top+bottom</em></li>
</ul>

<p>The full syntax is specified in the <a href="http://www.imagemagick.org/Magick++/Geometry.html">Magick::Geometry</a> documentation.</p>

<pre><code class="language-r"># Example image
frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
print(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754177a4044d.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Add 20px left/right and 10px top/bottom
image_border(image_background(frink, &quot;hotpink&quot;), &quot;#000080&quot;, &quot;20x10&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754131169898.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Trim margins
image_trim(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541427c3c55.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Passport pica
image_crop(frink, &quot;100x150+50&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75416a5d128c.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Resize
image_scale(frink, &quot;300&quot;) # width: 300px
</code></pre>

<p><img src="/img/tutorial-images/magick/file754146cdbe2.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r">image_scale(frink, &quot;x300&quot;) # height: 300px
</code></pre>

<p><img src="/img/tutorial-images/magick/file75416d7d4b3.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Rotate or mirror
image_rotate(frink, 45)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754143cd3747.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r">image_flip(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754155e83917.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r">image_flop(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541fc4111.png" alt="plot of chunk unnamed-chunk-5" /></p>

<pre><code class="language-r"># Paint the shirt orange
image_fill(frink, &quot;orange&quot;, point = &quot;+100+200&quot;, fuzz = 30000)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75413113c398.png" alt="plot of chunk unnamed-chunk-5" /></p>

<p>With <code>image_fill</code> we can flood fill starting at pixel <code>point</code>. The <code>fuzz</code> parameter allows for the fill to cross for adjecent pixels with similarish colors. Its value must be between 0 and 256^2 specifying the max geometric distance between colors to be considered equal. Here we give professor frink an orange shirt for the World Cup.</p>

<p><strong>Filters and effects</strong></p>

<p>ImageMagick also has a bunch of standard effects that are worth checking out.</p>

<pre><code class="language-r"># Add randomness
image_blur(frink, 10, 5)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754135702e2f.png" alt="plot of chunk unnamed-chunk-6" /></p>

<pre><code class="language-r">image_noise(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754157e82b11.png" alt="plot of chunk unnamed-chunk-6" /></p>

<pre><code class="language-r"># Silly filters
image_charcoal(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75414b63962d.png" alt="plot of chunk unnamed-chunk-6" /></p>

<pre><code class="language-r">image_oilpaint(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754177188b05.png" alt="plot of chunk unnamed-chunk-6" /></p>

<pre><code class="language-r">image_negate(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75416c4f3258.png" alt="plot of chunk unnamed-chunk-6" /></p>

<p><strong>Text annotation</strong></p>

<p>Finally it can be useful to print some text on top of images:</p>

<pre><code class="language-r"># Add some text
image_annotate(frink, &quot;I like R!&quot;, size = 70, gravity = &quot;southwest&quot;, color = &quot;green&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541bc5816b.png" alt="plot of chunk unnamed-chunk-7" /></p>

<pre><code class="language-r"># Customize text
image_annotate(frink, &quot;CONFIDENTIAL&quot;, size = 30, color = &quot;red&quot;, boxcolor = &quot;pink&quot;,
  degrees = 60, location = &quot;+50+100&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754153b39dd6.png" alt="plot of chunk unnamed-chunk-7" /></p>

<pre><code class="language-r"># Only works if ImageMagick has fontconfig
try(image_annotate(frink, &quot;The quick brown fox&quot;, font = 'times-new-roman', size = 30), silent = T)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541353f7788.png" alt="plot of chunk unnamed-chunk-7" /></p>

<p>If your system has difficulty finding a font, you can also specify the full path to the font file in the <code>font</code> parameter.</p>

<p><strong>Combining with pipes</strong></p>

<p>Each of the image transformation functions returns a <strong>modified copy</strong> of the original image. It does not affect the original image.</p>

<pre><code class="language-r">frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
frink2 &lt;- image_scale(frink, &quot;100&quot;)
image_info(frink)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    PNG   220    445       sRGB    73494
</code></pre>

<pre><code class="language-r">image_info(frink2)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    PNG   100    202       sRGB        0
</code></pre>

<p>Hence to combine transformations you need to chain them:</p>

<pre><code class="language-r">test &lt;- image_rotate(frink, 90)
test &lt;- image_background(test, &quot;blue&quot;, flatten = TRUE)
test &lt;- image_border(test, &quot;red&quot;, &quot;10x10&quot;)
test &lt;- image_annotate(test, &quot;This is how we combine transformations&quot;, color = &quot;white&quot;, size = 30)
print(test)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754121980f48.png" alt="plot of chunk unnamed-chunk-9" /></p>

<p>Using <code>magrittr</code> pipe syntax makes it a bit more readable</p>

<pre><code class="language-r">image_read(&quot;https://jeroen.github.io/images/frink.png&quot;) %&gt;%
  image_rotate(270) %&gt;%
  image_background(&quot;blue&quot;, flatten = TRUE) %&gt;%
  image_border(&quot;red&quot;, &quot;10x10&quot;) %&gt;%
  image_annotate(&quot;The same thing with pipes&quot;, color = &quot;white&quot;, size = 30)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75412a039441.png" alt="plot of chunk unnamed-chunk-10" /></p>

<h3 id="image-vectors">Image Vectors</h3>

<p>The examples above concern single images. However all functions in magick have been vectorized to support working with layers, compositions or animation.</p>

<p>The standard base methods <code>[</code> <code>[[</code>, <code>c()</code> and <code>length()</code> are used to manipulate vectors of images which can then be treated as layers or frames.</p>

<pre><code class="language-r">earth &lt;- image_read(&quot;https://jeroen.github.io/images/earth.gif&quot;)
earth &lt;- image_scale(earth, &quot;200&quot;)
length(earth)
</code></pre>

<pre><code>#&gt; [1] 44
</code></pre>

<pre><code class="language-r">head(image_info(earth))
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    GIF   200    200       sRGB        0
#&gt; 2    GIF   200    200       sRGB        0
#&gt; 3    GIF   200    200       sRGB        0
#&gt; 4    GIF   200    200       sRGB        0
#&gt; 5    GIF   200    200       sRGB        0
#&gt; 6    GIF   200    200       sRGB        0
</code></pre>

<pre><code class="language-r">print(earth)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75417eda5023.gif" alt="plot of chunk unnamed-chunk-11" /></p>

<pre><code class="language-r">rev(earth) %&gt;%
  image_flip() %&gt;%
  image_annotate(&quot;meanwhile in Australia&quot;, size = 20, color = &quot;white&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75412ec36ae5.gif" alt="plot of chunk unnamed-chunk-11" /></p>

<p><strong>Layers</strong></p>

<p>We can stack layers on top of each other as we would in Photoshop:</p>

<pre><code class="language-r">bigdata &lt;- image_read('https://jeroen.github.io/images/bigdata.jpg')
frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;)
logo &lt;- image_read(&quot;https://www.r-project.org/logo/Rlogo.png&quot;)
img &lt;- c(bigdata, logo, frink)
img &lt;- image_scale(img, &quot;300x300&quot;)
image_info(img)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1   JPEG   300    225       sRGB        0
#&gt; 2    PNG   300    232       sRGB        0
#&gt; 3    PNG   148    300       sRGB        0
</code></pre>

<p>A mosaic prints images on top of one another, expanding the output canvas such that that everything fits:</p>

<pre><code class="language-r">image_mosaic(img)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754194dc561.jpeg" alt="plot of chunk unnamed-chunk-13" /></p>

<p>Flattening combines the layers into a single image which has the size of the first image:</p>

<pre><code class="language-r">image_flatten(img)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541713e154b.jpeg" alt="plot of chunk unnamed-chunk-14" /></p>

<p>Flattening and mosaic allow for specifying alternative <a href="https://www.imagemagick.org/Magick++/Enumerations.html#CompositeOperator">composite operators</a>:</p>

<pre><code class="language-r">image_flatten(img, 'Add')
</code></pre>

<p><img src="/img/tutorial-images/magick/file754137dc5435.jpeg" alt="plot of chunk unnamed-chunk-15" /></p>

<pre><code class="language-r">image_flatten(img, 'Modulate')
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541621c8039.jpeg" alt="plot of chunk unnamed-chunk-15" /></p>

<pre><code class="language-r">image_flatten(img, 'Minus')
</code></pre>

<p><img src="/img/tutorial-images/magick/file75413d265081.jpeg" alt="plot of chunk unnamed-chunk-15" /></p>

<p><strong>Combining</strong></p>

<p>Appending means simply putting the frames next to each other:</p>

<pre><code class="language-r">left_to_right &lt;- image_append(image_scale(img, &quot;x200&quot;))
image_background(left_to_right, &quot;white&quot;, flatten = TRUE)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541233025b8.jpeg" alt="plot of chunk unnamed-chunk-16" /></p>

<p>Use <code>stack = TRUE</code> to position them on top of each other:</p>

<pre><code class="language-r">top_to_bottom &lt;- image_append(image_scale(img, &quot;100&quot;), stack = TRUE)
image_background(top_to_bottom, &quot;white&quot;, flatten = TRUE)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754115501ba2.jpeg" alt="plot of chunk unnamed-chunk-17" /></p>

<p>Composing allows for combining two images on a specific position:</p>

<pre><code class="language-r">bigdatafrink &lt;- image_scale(image_rotate(image_background(frink, &quot;none&quot;), 300), &quot;x200&quot;)
image_composite(image_scale(bigdata, &quot;x400&quot;), bigdatafrink, offset = &quot;+180+100&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754172e666b4.jpeg" alt="plot of chunk unnamed-chunk-18" /></p>

<p><strong>Pages</strong></p>

<p>When reading a PDF document, each page becomes an element of the vector. Note that PDF gets rendered while reading so you need to specify the density immediately.</p>

<pre><code class="language-r">manual &lt;- image_read('https://cran.r-project.org/web/packages/magick/magick.pdf', density = &quot;72x72&quot;)
image_info(manual)

# Convert the first page to PNG
image_convert(manual[1], &quot;png&quot;, 8)
</code></pre>

<p>Magick requires ghostscript to render the PDF. An alternative method to read pdf is render it via the pdftools package:</p>

<pre><code class="language-r">library(pdftools)
bitmap &lt;- pdf_render_page('https://cran.r-project.org/web/packages/magick/magick.pdf',
  page = 1, dpi = 72, numeric = FALSE)
image_read(bitmap)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754173cbac2a.png" alt="plot of chunk unnamed-chunk-20" /></p>

<p><strong>Animation</strong></p>

<p>Instead of treating vector elements as layers, we can also make them frames in an animation!</p>

<pre><code class="language-r">image_animate(image_scale(img, &quot;200x200&quot;), fps = 1, dispose = &quot;previous&quot;)
</code></pre>

<p><img src="/img/tutorial-images/magick/file75414215dae5.gif" alt="plot of chunk unnamed-chunk-21" /></p>

<p>Morphing creates a sequence of <code>n</code> images that gradually morph one image into another. It makes animations</p>

<pre><code class="language-r">newlogo &lt;- image_scale(image_read(&quot;https://www.r-project.org/logo/Rlogo.png&quot;), &quot;x150&quot;)
oldlogo &lt;- image_scale(image_read(&quot;https://developer.r-project.org/Logo/Rlogo-3.png&quot;), &quot;x150&quot;)
frames &lt;- image_morph(c(oldlogo, newlogo), frames = 10)
image_animate(frames)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541221105f1.gif" alt="plot of chunk unnamed-chunk-22" /></p>

<p>If you read in an existing GIF or Video file, each frame becomes a layer:</p>

<pre><code class="language-r"># Foreground image
banana &lt;- image_read(&quot;https://jeroen.github.io/images/banana.gif&quot;)
banana &lt;- image_scale(banana, &quot;150&quot;)
image_info(banana)
</code></pre>

<pre><code>#&gt;   format width height colorspace filesize
#&gt; 1    GIF   150    148       sRGB        0
#&gt; 2    GIF   150    148       sRGB        0
#&gt; 3    GIF   150    148       sRGB        0
#&gt; 4    GIF   150    148       sRGB        0
#&gt; 5    GIF   150    148       sRGB        0
#&gt; 6    GIF   150    148       sRGB        0
#&gt; 7    GIF   150    148       sRGB        0
#&gt; 8    GIF   150    148       sRGB        0
</code></pre>

<p>Manipulate the individual frames and put them back into an animation:</p>

<pre><code class="language-r"># Background image
background &lt;- image_background(image_scale(logo, &quot;200&quot;), &quot;white&quot;, flatten = TRUE)

# Combine and flatten frames
frames &lt;- image_apply(banana, function(frame) {
  image_composite(background, frame, offset = &quot;+70+30&quot;)
})

# Turn frames into animation
animation &lt;- image_animate(frames, fps = 10)
print(animation)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754140172b8a.gif" alt="plot of chunk unnamed-chunk-24" /></p>

<p>Animations can be saved as GIF of MPEG files:</p>

<pre><code class="language-r">image_write(animation, &quot;Rlogo-banana.gif&quot;)
</code></pre>

<h3 id="drawing-and-graphics">Drawing and Graphics</h3>

<p>A relatively recent addition to the package is a native R graphics device which produces a magick image object. This can either be used like a regular device for making plots, or alternatively to open a device which draws onto an existing image using pixel coordinates.</p>

<p><strong>Graphics device</strong></p>

<p>The <code>image_graph()</code> function opens a new graphics device similar to e.g. <code>png()</code> or <code>x11()</code>. It returns an image objec to which the plot(s) will be written. Each &ldquo;page&rdquo; in the plotting device will become a frame in the image object.</p>

<pre><code class="language-r"># Produce image using graphics device
fig &lt;- image_graph(width = 400, height = 400, res = 96)
ggplot2::qplot(mpg, wt, data = mtcars, colour = cyl)
dev.off()
</code></pre>

<p>We can easily postprocess the figure using regular image operations.</p>

<pre><code class="language-r"># Combine
out &lt;- image_composite(fig, frink, offset = &quot;+70+30&quot;)
print(out)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754174f7f84d.png" alt="plot of chunk unnamed-chunk-26" /></p>

<p><strong>Drawing device</strong></p>

<p>Another way to use the graphics device is to draw on top of an exiting image using pixel coordinates.</p>

<pre><code class="language-r"># Or paint over an existing image
img &lt;- image_draw(frink)
rect(20, 20, 200, 100, border = &quot;red&quot;, lty = &quot;dashed&quot;, lwd = 5)
abline(h = 300, col = 'blue', lwd = '10', lty = &quot;dotted&quot;)
text(30, 250, &quot;Hoiven-Glaven&quot;, family = &quot;courier&quot;, cex = 4, srt = 90)
palette(rainbow(11, end = 0.9))
symbols(rep(200, 11), seq(0, 400, 40), circles = runif(11, 5, 35),
  bg = 1:11, inches = FALSE, add = TRUE)
dev.off()
</code></pre>

<pre><code class="language-r">print(img)
</code></pre>

<p><img src="/img/tutorial-images/magick/file7541787207f7.png" alt="plot of chunk unnamed-chunk-28" /></p>

<p>By default <code>image_draw()</code> sets all margins to 0 and uses graphics coordinates to match image size in pixels (width x height) where (0,0) is the top left corner. Note that this means the y axis increases from top to bottom which is the opposite of typical graphics coordinates. You can override all this by passing custom <code>xlim</code>, <code>ylim</code> or <code>mar</code> values to <code>image_draw</code>.</p>

<p><strong>Animated Graphics</strong></p>

<p>The graphics device supports multiple frames which makes it easy to create animated graphics. The code below shows how you would implement the example from the very cool <a href="https://github.com/dgrtwo/gganimate">gganimate</a> package using the magick graphics device.</p>

<pre><code class="language-r">library(gapminder)
library(ggplot2)
img &lt;- image_graph(600, 400, res = 96)
datalist &lt;- split(gapminder, gapminder$year)
out &lt;- lapply(datalist, function(data){
  p &lt;- ggplot(data, aes(gdpPercap, lifeExp, size = pop, color = continent)) +
    scale_size(&quot;population&quot;, limits = range(gapminder$pop)) + geom_point() + ylim(20, 90) +
    scale_x_log10(limits = range(gapminder$gdpPercap)) + ggtitle(data$year) + theme_classic()
  print(p)
})
dev.off()
img &lt;- image_background(image_trim(img), 'white')
animation &lt;- image_animate(img, fps = 2)
print(animation)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754162961005.gif" alt="plot of chunk unnamed-chunk-30" /></p>

<p>To write it to a file you would simply do:</p>

<pre><code class="language-r">image_write(animation, &quot;gapminder.gif&quot;)
</code></pre>

<h3 id="raster-images">Raster Images</h3>

<p>Magick images can also be converted to raster objects for use with R&rsquo;s graphics device. Thereby we can combine it with other graphics tools. However do note that R&rsquo;s graphics device is very slow and has a very different coordinate system which reduces the quality of the image.</p>

<p><strong>Base R rasters</strong></p>

<p>Base R has an <code>as.raster</code> format which converts the image to a vector of strings. The paper <a href="https://journal.r-project.org/archive/2011-1/RJournal_2011-1_Murrell.pdf">Raster Images in R Graphics</a> by Paul Murrell gives a nice overview.</p>

<pre><code class="language-r">plot(as.raster(frink))
</code></pre>

<p><img src="/img/tutorial-images/magick/unnamed-chunk-31-1.png" alt="plot of chunk unnamed-chunk-31" /></p>

<pre><code class="language-r"># Print over another graphic
plot(cars)
rasterImage(frink, 21, 0, 25, 80)
</code></pre>

<p><img src="/img/tutorial-images/magick/unnamed-chunk-32-1.png" alt="plot of chunk unnamed-chunk-32" /></p>

<p><strong>The <code>grid</code> package</strong></p>

<p>The <code>grid</code> package makes it easier to overlay a raster on the graphics device without having to adjust for the x/y coordinates of the plot.</p>

<pre><code class="language-r">library(ggplot2)
library(grid)
qplot(speed, dist, data = cars, geom = c(&quot;point&quot;, &quot;smooth&quot;))
grid.raster(frink)
</code></pre>

<p><img src="/img/tutorial-images/magick/unnamed-chunk-33-1.png" alt="plot of chunk unnamed-chunk-33" /></p>

<p><strong>The <code>raster</code> package</strong></p>

<p>The <code>raster</code> package has it&rsquo;s own classes for bitmaps which are useful for spatial applications. The simplest way to convert an image to raster is export it as a <code>tiff</code> file:</p>

<pre><code class="language-r">tiff_file &lt;- tempfile()
image_write(frink, path = tiff_file, format = 'tiff')
r &lt;- raster::brick(tiff_file)
raster::plotRGB(r)
</code></pre>

<p><img src="/img/tutorial-images/magick/unnamed-chunk-34-1.png" alt="plot of chunk unnamed-chunk-34" /></p>

<p>You can also manually convert the bitmap array into a raster object, but this seems to drop some meta data:</p>

<pre><code class="language-r">buf &lt;- as.integer(frink[[1]])
rr &lt;- raster::brick(buf)
raster::plotRGB(rr, asp = 1)
</code></pre>

<p><img src="/img/tutorial-images/magick/unnamed-chunk-35-1.png" alt="plot of chunk unnamed-chunk-35" /></p>

<p>The raster package also does not seem to support transparency, which perhaps makes sense in the context of spatial imaging.</p>

<h3 id="ocr-text-extraction">OCR text extraction</h3>

<p>A recent edition to the package is to extract text from images using OCR. This requires the tesseract package:</p>

<pre><code class="language-r">install.packages(&quot;tesseract&quot;)
</code></pre>

<pre><code class="language-r">img &lt;- image_read(&quot;http://jeroen.github.io/images/testocr.png&quot;)
print(img)
</code></pre>

<p><img src="/img/tutorial-images/magick/file754171bcbbfa.png" alt="plot of chunk unnamed-chunk-37" /></p>

<pre><code class="language-r"># Extract text
cat(image_ocr(img))
</code></pre>

<pre><code>#&gt; This is a lot of 12 point text to test the
#&gt; cor code and see if it works on all types
#&gt; of file format.
#&gt;
#&gt; The quick brown dog jumped over the
#&gt; lazy fox. The quick brown dog jumped
#&gt; over the lazy fox. The quick brown dog
#&gt; jumped over the lazy fox. The quick
#&gt; brown dog jumped over the lazy fox.
</code></pre>

<h3 id="citing">Citing</h3>

<blockquote>
<p>Jeroen Ooms (2017). magick: Advanced Graphics and Image-Processing in
  R. R package version 1.4. <a href="https://CRAN.R-project.org/package=magick">https://CRAN.R-project.org/package=magick</a></p>
</blockquote>

<h3 id="license-and-bugs">License and bugs</h3>

<ul>
<li>License: <a href="http://opensource.org/licenses/MIT">MIT</a></li>
<li>Report bugs at <a href="https://github.com/ropensci/magick/issues?state=open">our GitHub repo for magick</a></li>
</ul>

<p><a href="#top">Back to top</a></p>

                    </article>
                </div>

                </div>
            </div>
        </div>
    </article>


    <div id="footer">
        <div class="container">
            <div class="row start">
                <div class="col-1 col-1-3 top-8">
                    <img src="/img/icon_short_white.svg" />
                </div>

                <div class="col-9 col-offset-2 top-10 bottom-8">
                    <div class="row between">
                        <div class="col-2 col-1-3">
                            <a href="http://github.com/ropensci" target="_blank"><div class="icon icon-github"></div></a>
                            <a href="http://twitter.com/ropensci" target="_blank"><div class="icon icon-twitter"></div></a>
                            <a href="http://vimeo.com/ropensci" target="_blank"><div class="icon icon-vimeo"></div></a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Info</h5>
                                <li><a href="/about">Mission</a></li>
                                <li><a href="/about#team">Team</a></li>
                                <li><a href="/about#collaborators">Collaborators</a></li>
                                <li><a href="/careers">Careers</a></li>

                            </ul>
                        </div>

                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Work</h5>
                                <li><a href="/packages/">Packages</a></li>
                                <li><a href="/blog/">Blog</a></li>
                                <li><a href="/technotes/">Tech Notes</a></li>
                                <li><a href="/tutorials/">Tutorials</a></li>
                                <li><a href="/usecases/">Use Cases</a></li>
                                <li><a href="/resources/">More Resources</a></li>
                            </ul>
                        </div>
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Participate</h5>
                                <li><a href="/contact.html">Contact us</a></li>
                                <li><a href="/community/">Community</a></li>
                                <li><a href="http://onboarding.ropensci.org/">Contribute software</a></li>
                                <li><a href="http://unconf17.ropensci.org/">Unconference</a></li>
                                <li><a href="/coc">Code of conduct</a></li>
                                <li><a href="/donate/">Donate</a></li>
                            </ul>
                        </div>
                        <div class="col-4 top-8 bottom-8">
                            <h5 class="bottom-2"></h5>

                            <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" target="_blank">NumFOCUS</a></p>
                            <a href="http://numfocus.org" target="_blank"><img src="img/numfocus.png"></a>
                            <br>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 top-8 bottom-9 divider">
                    <p class="top-9">Except where otherwise noted, content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY license</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>




    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    

    
    <script type="text/javascript" src="/js/highlight.pack.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>



</body>
</html>
