<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>rOpenSci | Magick 1.6: clipping, geometries, fonts, fuzz, and a bit of history</title>

     
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>
    <link rel="stylesheet" type="text/css" href="/css/style-new.css" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#4b8add">
<meta name="theme-color" content="#4b8add">


    <meta name="viewport" content="width=device-width, initial-scale=1">

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-462421-6', 'auto');
ga('send', 'pageview');
</script>

</head>
<body>

    
    <div id="header">
        <div class="container">
            <div class="row center-m">
                
                <div class="col-1">
                    <a href="/index.html"><img src="/img/icon_lettering_white.svg" /></a>
                </div>
                
                
                <nav class="col-6 col-offset-4 top-3">
                    <ul class="row between">
						<li><a href="/about/">About</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/packages/">Packages</a></li>
                        <li><a href="/community/">Community</a></li>
                        <li><a href="http://discuss.ropensci.org/" target="_blank">Discuss</a></li>

                    </ul>
                </nav>
                
            </div>
        </div>
    </div>


<article class="blog-post">
    <div class="container">
        <div class="row">
            <div class="col-2 sidebar top-5">
                <ul class="autoSidebar"></ul>
            </div> 
        </div>
        <div class="row">
            <div class="col-offset-2 col-8 top-20">
                <h1 style="text-align: center;">Magick 1.6: clipping, geometries, fonts, fuzz, and a bit of history</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-offset-2 col-8 top-10 bottom-5" style="font-size: 20px; text-align: center;">
                <p class="authors" style="text-align: center;">
                    
                        &nbsp;
                        
                          <a href="/about/#team">Jeroen Ooms</a>
                        
                        
                        &nbsp; |
                    
                    <small style="color: #5B617A; margin-left: 10px;"> DECEMBER 5, 2017</small>
                </p>
            </div>
            <div class="col-offset-2 col-8 top-2">
                

<p>This week <a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html">magick</a> 1.6 appeared on CRAN. This release is a big all-round maintenance update with lots of tweaks and improvements across the package.</p>

<p>The <a href="https://cran.r-project.org/web/packages/magick/NEWS">NEWS</a> file gives an overview of changes in this version. In this post we highlight some changes.</p>

<pre><code class="language-r">library(magick)
stopifnot(packageVersion('magick') &gt;= 1.6)
</code></pre>

<p>If you are new to magick, check out the <a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html">vignette</a> for a quick introduction.</p>

<h2 id="perfect-graphics-rendering">Perfect Graphics Rendering</h2>

<p>I have fixed a few small rendering imperfections in the graphics device. The native magick graphics device <code>image_graph()</code> now renders identical or better quality images as the R-base bitmap devices <code>png</code>, <code>jpeg</code>, etc.</p>

<p>One issue was that sometimes magick graphics would show a 1px black border around the image. It turned out this is caused by rounding of clipping coordinates.</p>

<p>When R calculates clipping area it often ends up at non-whole values. It is then up to the graphics device to decide what to do with the pixel that is partially clipped. Let&rsquo;s show clipping in action:</p>

<pre><code class="language-r">testplot &lt;- function(title = &quot;&quot;){
  plot(1, main = title)
  abline(0, 1, col = &quot;blue&quot;, lwd = 2, lty = &quot;solid&quot;)
  abline(0.1, 1, col = &quot;red&quot;, lwd = 3, lty = &quot;dotted&quot;)
  abline(0.2, 1, col = &quot;green&quot;, lwd = 4, lty = &quot;twodash&quot;)
  abline(0.3, 1, col = &quot;black&quot;, lwd = 5, lty = &quot;dotdash&quot;)
  abline(0.4, 1, col = &quot;purple&quot;, lwd = 6, lty = &quot;dashed&quot;)
  abline(0.5, 1, col = &quot;yellow&quot;, lwd = 7, lty = &quot;longdash&quot;)
  abline(-0.1, 1, col = &quot;blue&quot;, lwd = 10, lend = &quot;round&quot;, lty = &quot;dashed&quot;)
  abline(-0.2, 1, col = &quot;blue&quot;, lwd = 10, lend = &quot;butt&quot;, lty = &quot;dashed&quot;)
  abline(-0.3, 1, col = &quot;blue&quot;, lwd = 10, lend = &quot;square&quot;, lty = &quot;dashed&quot;)
}
</code></pre>

<p>Now we run it with and without clipping:</p>

<pre><code class="language-r">img2 &lt;- magick::image_graph(clip = FALSE)
testplot(&quot;Without clipping&quot;)
dev.off()
</code></pre>

<p><img src="https://i.imgur.com/TtpjlLq.png" alt="noclip.png" /></p>

<pre><code class="language-r">img1 &lt;- magick::image_graph(clip = TRUE)
testplot(&quot;With clipping&quot;)
dev.off()
</code></pre>

<p><img src="https://i.imgur.com/JbWMElL.png" alt="clip.png" /></p>

<p>As we can see the latter image is now perfectly clipped. The colored lines are truncated exactly at the pixel where the axis starts. This is not always the case in base R ;)</p>

<h2 id="font-families">Font Families</h2>

<p>In magick there are two ways to render text on an image. You can either open the image or graphic in the magick graphics device and then use base R <code>text()</code> function to print text. Alternatively there is <code>image_annotate()</code> which is a simpler version to print some text on an image.</p>

<p>Wherever text rendering is involved, two major headache arise: encoding and fonts. The latter is tricky because different operating systems have different fonts with different names. In addition a font can be specified as a name, or family name, or alias.</p>

<p>Below is a simple test that I use to quickly inspect if fonts are working on different systems:</p>

<pre><code class="language-r">img &lt;- image_graph(width = 800, height = 500, pointsize = 20, res = 96)
graphics::plot.new()
graphics::par(mar = c(0,0,3,0))
graphics::plot.window(xlim = c(0, 20), ylim = c(-.5, 8))
title(expression(Gamma %prop% sum(x[alpha], i==1, n) * sqrt(mu)), expression(hat(x)))

# Standard families as supported by other devices
text(0.95, 7, &quot;abcdefg  - Helvetica&quot;, pos = 4, family = &quot;helvetica&quot;)
text(0.95, 6, &quot;abcdefg  - Sans (Arial)&quot;, pos = 4, family = &quot;sans&quot;)
text(0.95, 5, &quot;abcdefg - Serif (Times)&quot;, pos = 4, family = &quot;serif&quot;)
text(0.95, 4, &quot;abcdefg - Monospace (Courier New)&quot;, pos = 4, family = &quot;mono&quot;)
text(0.95, 3, &quot;abcdefg - Symbol Face&quot;, pos = 4, font = 5)
text(0.95, 2, &quot;abcdefg  - Comic Sans&quot;, pos = 4, family = &quot;Comic Sans&quot;)
text(0.95, 1, &quot;abcdefg - Georgia Serif&quot;, pos = 4, family = &quot;Georgia&quot;)
text(0.95, 0, &quot;abcdefg - Courier&quot;, pos = 4, family = &quot;Courier&quot;)
dev.off()
img &lt;- image_border(img, 'red', geometry = '2x2')
</code></pre>

<p><img src="https://i.imgur.com/tzIktip.png" alt="families" /></p>

<p>R requires that a graphics device supports at least 4 font types: <code>serif</code>, <code>sans</code>, <code>mono</code> and <code>symbol</code>. The latter is a special 8bit font with some Greek letters and other characters needed for rendering math. This set of fonts corresponds to the original <strong>13 base fonts</strong> from the <a href="https://en.wikipedia.org/wiki/PostScript_fonts#Core_Font_Set">1984 postscript standard</a>:</p>

<ul>
<li>4x Courier (Regular, Oblique, Bold, Bold Oblique)</li>
<li>4x Helvetica (Regular, Oblique, Bold, Bold Oblique)</li>
<li>4x Times (Roman, Italic, Bold, Bold Italic)</li>
<li>Symbol</li>
</ul>

<p>Below a photo of the 1985 <a href="https://en.wikipedia.org/wiki/LaserWriter">Apple Laser Writer</a> which was <a href="https://en.wikipedia.org/wiki/PostScript_fonts#History">the first laser printer</a> to use the PostScript language and support all these fonts! Not much later PostScript graphics devices were adopted by R&rsquo;s predecessor <a href="https://en.wikipedia.org/wiki/S_(programming_language)#.22New_S.22">&ldquo;The New S&rdquo;</a> (The New S Language, 1988).</p>

<p><img src="http://theappletimeline.com/images/color1000.jpg" alt="printers" /></p>

<h2 id="geometry-helpers">Geometry Helpers</h2>

<p>Another major improvement in this release is the introduction of helper functions for geometry and option strings. Many functions in magick require a special geometry syntax to specify a size, area, or point. For example to resize an image you need to specify a size:</p>

<pre><code class="language-r">image_resize(img, &quot;50%&quot;)
image_resize(img, &quot;300x300&quot;)
image_resize(img, &quot;300x300!&quot;)
</code></pre>

<p>Or to crop you need to specify an area which consists of a size and offset:</p>

<pre><code class="language-r">image_crop(img, &quot;300x300+100+100&quot;)
</code></pre>

<p>We added a few handy <code>?geometry</code> helper functions to generate proper geometry syntax</p>

<p><img src="https://i.imgur.com/2jivLxi.png" alt="geometries" /></p>

<h2 id="magick-options">Magick Options</h2>

<p>A lot of the power in ImageMagick is contained in the hundreds of built-in filters, colorspaces, compose operators, disposal types, convolution kernels, noise types and what not. These are specified simply as a string in the function.</p>

<p>For example in our previous <a href="https://ropensci.org/technotes/2017/11/02/image-convolve/">post about Image Convolution</a> we discussed a few kernel types:</p>

<pre><code class="language-r"># Gaussian Kernel
img %&gt;% image_convolve('Gaussian:0x5', scaling = '60,40%')

# Sobel Kernel
img %&gt;% image_convolve('Sobel')

# Difference of Gaussians
img %&gt;% image_convolve('DoG:0,0,2')
</code></pre>

<p>Supported values for each option are described in the online ImageMagick documentation. We now have added functions in the magick package that list all values for each option. This should make it a easier to see what is supported and harness the full power of built-in ImageMagick algorithms.</p>

<p><img src="https://i.imgur.com/cid6JqU.png" alt="options" /></p>

<p>So we can now easily list e.g. supported kernel types:</p>

<pre><code class="language-r">&gt; kernel_types()
 [1] &quot;Undefined&quot;     &quot;Unity&quot;         &quot;Gaussian&quot;      &quot;DoG&quot;          
 [5] &quot;LoG&quot;           &quot;Blur&quot;          &quot;Comet&quot;         &quot;Binomial&quot;     
 [9] &quot;Laplacian&quot;     &quot;Sobel&quot;         &quot;FreiChen&quot;      &quot;Roberts&quot;      
[13] &quot;Prewitt&quot;       &quot;Compass&quot;       &quot;Kirsch&quot;        &quot;Diamond&quot;      
[17] &quot;Square&quot;        &quot;Rectangle&quot;     &quot;Disk&quot;          &quot;Octagon&quot;      
[21] &quot;Plus&quot;          &quot;Cross&quot;         &quot;Ring&quot;          &quot;Peaks&quot;        
[25] &quot;Edges&quot;         &quot;Corners&quot;       &quot;Diagonals&quot;     &quot;ThinDiagonals&quot;
[29] &quot;LineEnds&quot;      &quot;LineJunctions&quot; &quot;Ridges&quot;        &quot;ConvexHull&quot;   
[33] &quot;ThinSe&quot;        &quot;Skeleton&quot;      &quot;Chebyshev&quot;     &quot;Manhattan&quot;    
[37] &quot;Octagonal&quot;     &quot;Euclidean&quot;     &quot;User Defined&quot; 
</code></pre>

<p>That&rsquo;s a lot of kernels.</p>

<h2 id="fuzz-scaling">Fuzz Scaling</h2>

<p>Finally one more (breaking) change: several functions in magick use a <code>fuzz</code> parameter to specify the max distance between two colors to be considered similar.</p>

<p>For example the flood fill algorithm (the paint-bucket button in ms-paint) changes the color of a given starting pixel, and then recursively all adjacent pixels that have the same color. However sometimes neighboring pixels are not precisely the same color, but nearly the same. The <code>fuzz</code> parameter allows the fill to continue when pixels are not the same but similar color.</p>

<pre><code class="language-r"># Paint the shirt orange
frink &lt;- image_read(&quot;https://jeroen.github.io/images/frink.png&quot;) %&gt;%
  image_fill(&quot;orange&quot;, point = &quot;+100+200&quot;, fuzz = 25)
</code></pre>

<p><img src="https://i.imgur.com/VwlqYWy.png" alt="frink" /></p>

<p>What has changed in this version is that <code>fuzz</code> parameter been rescaled to a percentage. Hence you should always provide a value between 0 and 100. Previously it was the absolute distance between colors, but this depends on the type and color depth of the image at hand, which was very confusing.</p>

            </div>
            <br>


            
            
            <div class="col-offset-2 col-8 top-4">
                <div id='discourse-comments'></div>
                <script type="text/javascript">
                DiscourseEmbed = { discourseUrl: 'https://discuss.ropensci.org/',
                                   topicId:  987  };
                (function() {
                  var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
                  d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
                })();
                </script>
            </div>
            
        </div>
        <br>
    </div>
</article>





    <div id="footer">
        <div class="container">
            <div class="row start">
                <div class="col-1 col-1-3 top-8">
                    <img src="/img/icon_short_white.svg" />
                </div>

                <div class="col-9 col-offset-2 top-10 bottom-8">
                    <div class="row between">
                        <div class="col-2 col-1-3">
                            <a href="http://github.com/ropensci" target="_blank"><div class="icon icon-github"></div></a>
                            <a href="http://twitter.com/ropensci" target="_blank"><div class="icon icon-twitter"></div></a>
                            <a href="http://vimeo.com/ropensci" target="_blank"><div class="icon icon-vimeo"></div></a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Info</h5>
                                <li><a href="/about">Mission</a></li>
                                <li><a href="/about#team">Team</a></li>
                                <li><a href="/about#collaborators">Collaborators</a></li>
                                <li><a href="/careers">Careers</a></li>

                            </ul>
                        </div>

                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Work</h5>
                                <li><a href="/packages/">Packages</a></li>
                                <li><a href="/blog/">Blog</a></li>
                                <li><a href="/technotes/">Tech Notes</a></li>
                                <li><a href="/tutorials/">Tutorials</a></li>
                                <li><a href="/usecases/">Use Cases</a></li>
                                <li><a href="/resources/">More Resources</a></li>
                            </ul>
                        </div>
                        <div class="col-2 col-1-3 top-8 bottom-8">
                            <ul>
                                <h5 class="bottom-2">Participate</h5>
                                <li><a href="/contact.html">Contact us</a></li>
                                <li><a href="/community/">Community</a></li>
                                <li><a href="http://onboarding.ropensci.org/">Contribute software</a></li>
                                <li><a href="http://unconf17.ropensci.org/">Unconference</a></li>
                                <li><a href="/coc">Code of conduct</a></li>
                                <li><a href="/donate/">Donate</a></li>
                            </ul>
                        </div>
                        <div class="col-4 top-8 bottom-8">
                            <h5 class="bottom-2"></h5>

                            <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" target="_blank">NumFOCUS</a></p>
                            <a href="http://numfocus.org" target="_blank"><img src="img/numfocus.png"></a>
                            <br>

                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 top-8 bottom-9 divider">
                    <p class="top-9">Except where otherwise noted, content on this site is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY license</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>



</body>
</html>



